{% extends "layouts/base_v2.html" %}
{% set active = None %}

{% block content %}
<div class="grid grid-cols-12 gap-8 items-start">
        <!-- Левое меню -->
        <div class="col-span-12 md:col-span-4">
            {% include "components/account_tabs.html" with context %}
        </div>

        <!-- Контент -->
        <div class="col-span-12 md:col-span-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm ring-1 ring-neutral-200/70">
                {% if request.query_params.get('purchased') %}
                <div class="mb-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-700">
                    ✅ Проверки успешно добавлены! Теперь у вас больше доступных проверок.
                </div>
                {% endif %}
                
                {% if not sub %}
                <h1 class="text-2xl font-semibold mb-4">Подписка</h1>
                <p class="text-neutral-700 max-w-2xl">
                    Оформите подписку, чтобы <b>сохранять историю проверок</b>,
                    получать <b>доступ к статистике</b> и иметь <b>приоритет</b> при модерации рекламы.
                </p>

                <form method="post" action="{{ url_for('web_v2_subscribe_start') }}" class="mt-6">
                    <button
                        class="inline-flex items-center px-5 py-2.5 rounded-xl bg-rose-500 text-white hover:bg-rose-600">
                        Оформить
                    </button>
                </form>
                {% else %}
                <div class="flex items-start justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-2xl font-semibold">Подписка активна</h1>
                        <div class="mt-1 text-neutral-600">
                            Тариф: <b>{{ sub.plan }}</b> · Стоимость: {{ sub.price }}
                        </div>
                        <div class="text-neutral-600">
                            Истекает: <b>{{ sub.expires_at_formatted }}</b> (осталось {{ sub.days_left }} дн.)
                        </div>
                    </div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm">
                        ● Активна
                    </span>
                </div>

                <div class="mt-6 grid sm:grid-cols-2 gap-4">
                    <div class="rounded-xl border border-neutral-200 p-4">
                        <div class="text-neutral-500 text-sm">Лимит проверок</div>
                        <div class="mt-1 text-xl font-semibold">
                            {{ sub.used }} / {{ sub.quota_month }}
                        </div>
                        {% set remaining = sub.quota_month - sub.used %}
                        <div class="mt-2 text-sm {{ 'text-red-600' if remaining < 10 else 'text-neutral-600' }}">
                            Осталось: {{ remaining }} {{ 'проверок' if remaining != 1 else 'проверка' }}
                        </div>
                    </div>
                    <div class="rounded-xl border border-neutral-200 p-4">
                        <div class="text-neutral-500 text-sm">Приоритет очереди</div>
                        <div class="mt-1 text-xl font-semibold">Высокий</div>
                    </div>
                </div>
                
                <!-- Блок докупки проверок -->
                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-5">
                    <h3 class="font-semibold text-blue-900 mb-2">Нужно больше проверок?</h3>
                    <p class="text-sm text-blue-800 mb-4">
                        Вы можете докупить дополнительные проверки по цене <strong>100 ₽ за 30 проверок</strong>
                    </p>
                    <form method="post" action="{{ url_for('web_v2_buy_checks') }}">
                        <button type="submit" class="px-5 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium">
                            Купить +30 проверок за 100 ₽
                        </button>
                    </form>
                </div>

                <div class="mt-6 flex flex-wrap gap-3">
                    <form method="post" action="{{ url_for('web_v2_subscribe_cancel') }}">
                        <button class="px-4 py-2 rounded-xl bg-neutral-100 hover:bg-neutral-200">
                            Отменить
                        </button>
                    </form>
                    <button class="px-4 py-2 rounded-xl border border-neutral-200 text-neutral-700 cursor-not-allowed"
                        title="Заглушка">
                        Изменить способ оплаты
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}