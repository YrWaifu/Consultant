{% extends "layouts/base_v2.html" %}
{% set active = "check" %}
{% block title %}–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–ª–∞–º—ã ‚Äî –ò–ò –º–æ–¥–µ—Ä–∞—Ç–æ—Ä —Ä–µ–∫–ª–∞–º—ã{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto text-center">
    <div class="mb-8">
        <div class="text-6xl mb-4">ü§ñ</div>
        <h1 class="text-2xl font-bold text-neutral-800 mb-2">
            –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à—É —Ä–µ–∫–ª–∞–º—É
        </h1>
        <p class="text-neutral-600">
            –ù–∞—à–∞ ML –º–æ–¥–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –§–ó ¬´–û —Ä–µ–∫–ª–∞–º–µ¬ª. 
            –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
        </p>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="mb-8">
        <div class="w-full bg-neutral-200 rounded-full h-2 mb-4">
            <div id="progressBar" class="bg-rose-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
        </div>
        <p id="statusText" class="text-sm text-neutral-500">
            –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É...
        </p>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ -->
    <div class="bg-neutral-50 rounded-2xl p-6 mb-8">
        <h3 class="font-semibold mb-4 text-neutral-800">–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å:</h3>
        <div class="space-y-3 text-left">
            <div id="step1" class="flex items-center gap-3">
                <div class="w-6 h-6 rounded-full bg-rose-600 flex items-center justify-center text-white text-sm">1</div>
                <span class="text-neutral-700">–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∫–ª–∞–º—ã —Å –ø–æ–º–æ—â—å—é –ò–ò</span>
                <div id="spinner1" class="ml-auto">
                    <div class="animate-spin h-4 w-4 border-2 border-rose-600 border-t-transparent rounded-full"></div>
                </div>
            </div>
            <div id="step2" class="flex items-center gap-3 opacity-50">
                <div class="w-6 h-6 rounded-full bg-neutral-300 flex items-center justify-center text-white text-sm">2</div>
                <span class="text-neutral-700">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–∞–º–∏ –∑–∞–∫–æ–Ω–∞</span>
                <div id="spinner2" class="ml-auto hidden">
                    <div class="animate-spin h-4 w-4 border-2 border-rose-600 border-t-transparent rounded-full"></div>
                </div>
            </div>
            <div id="step3" class="flex items-center gap-3 opacity-50">
                <div class="w-6 h-6 rounded-full bg-neutral-300 flex items-center justify-center text-white text-sm">3</div>
                <span class="text-neutral-700">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</span>
                <div id="spinner3" class="ml-auto hidden">
                    <div class="animate-spin h-4 w-4 border-2 border-rose-600 border-t-transparent rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã -->
    <div>
        <a href="/v2/check" 
           class="inline-flex items-center justify-center rounded-full border border-neutral-300 px-6 py-2 text-neutral-700 hover:bg-neutral-50">
            –û—Ç–º–µ–Ω–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const jobId = '{{ job_id }}';
    const progressBar = document.getElementById('progressBar');
    const statusText = document.getElementById('statusText');
    
    let progress = 0;
    let currentStep = 1;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const updateProgress = () => {
        if (progress < 95) { // –ù–µ –¥–æ–≤–æ–¥–∏–º –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            progress += Math.random() * 5;
            progressBar.style.width = Math.min(progress, 95) + '%';
        }
    };
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–≥–æ–≤
    const updateSteps = () => {
        if (progress > 30 && currentStep === 1) {
            currentStep = 2;
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —à–∞–≥ 2
            document.getElementById('step2').classList.remove('opacity-50');
            document.getElementById('step2').querySelector('.bg-neutral-300').classList.add('bg-rose-600');
            document.getElementById('step2').querySelector('.bg-neutral-300').classList.remove('bg-neutral-300');
            document.getElementById('spinner2').classList.remove('hidden');
            document.getElementById('spinner1').style.display = 'none';
            statusText.textContent = '–°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º —Å –Ω–æ—Ä–º–∞–º–∏ –∑–∞–∫–æ–Ω–∞...';
        } else if (progress > 60 && currentStep === 2) {
            currentStep = 3;
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —à–∞–≥ 3
            document.getElementById('step3').classList.remove('opacity-50');
            document.getElementById('step3').querySelector('.bg-neutral-300').classList.add('bg-rose-600');
            document.getElementById('step3').querySelector('.bg-neutral-300').classList.remove('bg-neutral-300');
            document.getElementById('spinner3').classList.remove('hidden');
            document.getElementById('spinner2').style.display = 'none';
            statusText.textContent = '–§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç...';
        }
    };
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/v2/check/status/${jobId}`);
            const data = await response.json();
            
            console.log('–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏:', data); // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            
            if (data.status === 'completed') {
                // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                progressBar.style.width = '100%';
                statusText.textContent = '–ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
                
                // –£–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
                document.querySelectorAll('[id^="spinner"]').forEach(s => s.style.display = 'none');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    window.location.href = `/v2/check/result/${jobId}`;
                }, 1000);
                
            } else if (data.status === 'failed') {
                statusText.textContent = '–û—à–∏–±–∫–∞: ML –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞';
                progressBar.style.width = '100%';
                progressBar.classList.remove('bg-rose-600');
                progressBar.classList.add('bg-red-600');
                
                // –£–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
                document.querySelectorAll('[id^="spinner"]').forEach(s => s.style.display = 'none');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
                setTimeout(() => {
                    alert('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                }, 2000);
                
            } else if (data.status === 'error') {
                statusText.textContent = `–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã: ${data.error}`;
                progressBar.style.width = '100%';
                progressBar.classList.remove('bg-rose-600');
                progressBar.classList.add('bg-red-600');
                
                // –£–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã
                document.querySelectorAll('[id^="spinner"]').forEach(s => s.style.display = 'none');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
                setTimeout(() => {
                    alert('–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }, 2000);
                
            } else {
                // –ó–∞–¥–∞—á–∞ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
                setTimeout(checkStatus, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            statusText.textContent = '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º, –ø–æ–≤—Ç–æ—Ä—è–µ–º...';
            setTimeout(checkStatus, 3000); // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        }
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
    const progressInterval = setInterval(() => {
        updateProgress();
        updateSteps();
    }, 500);
    
    // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(checkStatus, 2000);
});
</script>
{% endblock %}

